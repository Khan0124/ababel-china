# تصحيح منطق حساب أرصدة العملاء

## المشكلة السابقة
كان النظام يحسب أرصدة العملاء بطريقة خاطئة حيث كانت الفواتير تظهر كرصيد فائض للعميل بدلاً من دين مستحق عليه.

## النظام المحاسبي الجديد (الاحترافي)

### القاعدة الأساسية:
```
رصيد العميل = المدفوعات المستلمة - المبيعات والمصاريف
```

### تفسير الأرصدة:
- **رصيد سالب (-)**  = دين على العميل (العميل يدين للشركة)
- **رصيد موجب (+)**  = رصيد فائض للعميل (الشركة تدين للعميل)
- **رصيد صفر (0)**    = لا يوجد دين على العميل أو له

### أنواع المعاملات:
- **المبيعات** (expense/transfer): مثل شراء بضاعة، شحن، تحويل مكتب
  - تزيد الدين على العميل (تقلل الرصيد)
- **المدفوعات** (income): الأموال المستلمة من العميل
  - تقلل الدين على العميل (تزيد الرصيد)

## التغييرات المطبقة

### 1. تحديث Transaction Model
- تعديل دالة `updateClientBalance()`
- تعديل دالة `getClientBalancesByCurrency()`

### 2. تحديث Report Controller  
- تصحيح استعلام تقارير العملاء

### 3. الحفاظ على Helper Functions
- `formatBalance()` - تعرض الرصيد بالشكل الصحيح
- `getOutstandingAmount()` - تحسب المبلغ المستحق للدفع
- `getBalanceType()` - تحدد نوع الرصيد

## كيفية تطبيق التصحيح

### الطريقة الأولى: تشغيل SQL Script
```bash
mysql -u username -p database_name < migrations/fix_balance_calculation.sql
```

### الطريقة الثانية: تشغيل PHP Script
```bash
cd /www/wwwroot/khxtech.xyz
php fix_client_balances.php
```

## مثال على الحساب

### عميل له معاملات:
- فاتورة بضاعة: ¥1000 (نوع expense)
- دفعة مستلمة: ¥600 (نوع income)

### الحساب:
```
الرصيد = المدفوعات - المبيعات
       = ¥600 - ¥1000
       = -¥400
```

### النتيجة:
- الرصيد: -¥400 (سالب)
- المعنى: العميل يدين للشركة ¥400
- المبلغ المستحق للدفع: ¥400

## التحقق من صحة التطبيق

بعد تشغيل التصحيح، تأكد من:
1. الفواتير الجديدة تظهر كدين على العميل
2. المدفوعات تقلل الدين
3. العرض في واجهة المستخدم صحيح
4. التقارير تُظهر الأرصدة الصحيحة

## ملاحظات مهمة

- ⚠️ تأكد من عمل نسخة احتياطية من قاعدة البيانات قبل التطبيق
- 🔍 اختبر النظام بعناية بعد التطبيق
- 📊 راجع تقارير العملاء للتأكد من صحة الأرصدة
- 💡 النظام الجديد متوافق مع المعايير المحاسبية العالمية